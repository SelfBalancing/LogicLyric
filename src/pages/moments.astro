---
// src/pages/moments.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { transform } from 'astro:transitions';

// è·å–æ‰€æœ‰è¯´è¯´å†…å®¹
const moments = await getCollection('moments', ({ data }) => {
  return import.meta.env.DEV ? true : data.published
});

// æŒ‰æ—¥æœŸæ’åº
const sortedMoments = moments.sort((a, b) => 
  new Date(b.data.date) - new Date(a.data.date)
);
---

<BaseLayout title="è¯´è¯´">
  <main class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="text-4xl font-serif mb-12 text-center">ğŸ’¬ é—²è¨€ç¢è¯­</h1>
    
    <div class="waterfall-container">
      {sortedMoments.map(async (moment) => {
        const { Content } = await moment.render();
        return (
          <article class="moment-card animate-card-in">
            <div class="card p-6">
              <header class="flex items-center gap-3 mb-4">
                <span class="text-3xl">{moment.data.mood}</span>
                <div class="flex-1">
                  <time class="text-secondary text-sm">
                    {new Date(moment.data.date).toLocaleDateString('zh-CN', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </time>
                </div>
              </header>

              <section class="prose prose-sm dark:prose-invert max-w-none">
                <Content />
              </section>

              {moment.data.tags?.length > 0 && (
                <footer class="mt-4 flex flex-wrap gap-2">
                  {moment.data.tags.map(tag => (
                    <span class="px-2 py-1 bg-accent/10 text-accent rounded-full text-sm">
                      #{tag}
                    </span>
                  ))}
                </footer>
              )}
            </div>
          </article>
        )
      })}
    </div>
  </main>
</BaseLayout>

<style>
  /* ç€‘å¸ƒæµå¸ƒå±€ */
  .waterfall-container {
    column-count: 2;
    column-gap: 2rem;
  }
  .moment-card {
    break-inside: avoid;
    margin-bottom: 2rem;
  }

  /* å¡ç‰‡å…¥åœºåŠ¨ç”» */
  .animate-card-in {
    animation: card-in 0.6s ease-out both;
  }
  @keyframes card-in {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* å“åº”å¼å¸ƒå±€ */
  @media (max-width: 768px) {
    .waterfall-container {
      column-count: 1;
    }
  }

  /* å›¾ç‰‡ä¼˜åŒ– */
  .prose img {
    @apply rounded-xl my-4 shadow-lg transition-transform hover:scale-[1.02];
    width: 100% !important;
    height: auto !important;
  }

  /* æš—è‰²æ¨¡å¼é€‚é… */
  .dark .prose img {
    @apply brightness-90;
  }
</style>
